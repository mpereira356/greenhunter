{% extends "base.html" %}
{% block title %}Configurar Regra{% endblock %}
{% block content %}
{% set form = form_data if form_data is defined and form_data else None %}
{% set default_message = 'ğŸ“¢ {rule}\nâ±ï¸ Tempo: {minute}\'\nğŸŸï¸ {home_team} vs {away_team}\nğŸ¥… Placar: {score}\nğŸ¯ Ã€ Baliza: {on_target_home} x {on_target_away}\nğŸš© Escanteios: {corners_home} x {corners_away}\nğŸ”— Abrir no site ({url})' %}

<div class="builder-shell rule-editor">
  <div class="page-header mb-4">
    <div>
      <h1 class="page-title">ğŸš€ Criar HipÃ³tese de Aposta</h1>
      <p class="page-subtitle">Configure seus critÃ©rios de forma simples e receba alertas no Telegram.</p>
    </div>
  </div>

  <form method="post" id="rule-form" class="rule-form" novalidate>
    
    <!-- PASSO 1: IDENTIFICAÃ‡ÃƒO -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-9">
            <label class="form-label fw-bold">Nome da sua EstratÃ©gia</label>
            <input class="form-control form-control-lg border-2" name="name" id="rule-name" value="{{ form.name if form is not none else (rule.name if rule else '') }}" placeholder="Ex: Funil de Escanteios HT" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">Status</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" name="is_active" id="is_active" style="width: 3em; height: 1.5em;" {% if form is not none %}{% if form.is_active %}checked{% endif %}{% elif rule is none or rule.is_active %}checked{% endif %}>
            </div>
            <div class="form-check form-switch mt-3">
              <input class="form-check-input" type="checkbox" name="second_half_only" id="second_half_only" {% if form is not none %}{% if form.second_half_only %}checked{% endif %}{% elif rule and rule.second_half_only %}checked{% endif %}>
              <label class="form-check-label small text-muted" for="second_half_only">
                Somente 2Âº tempo (zerar stats do 1Âº)
              </label>
            </div>
            <div class="small text-muted mt-2" id="second-half-note" style="display: none;">
              No 2Âº tempo, os minutos sÃ£o contados de 0 a 45 (ex.: 46' vira 1).
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PASSO 2: QUANDO MONITORAR (TEMPO E PLACAR) -->
    <div class="row g-4 mb-4">
      <div class="col-md-12">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white py-3 border-0">
            <h6 class="mb-0 fw-bold text-primary">ğŸ¥… Filtro de Placar (Opcional)</h6>
          </div>
          <div class="card-body pt-0">
            <div class="row g-2">
              <div class="col-6">
                <label class="small text-muted">Gols Casa</label>
                <input class="form-control" type="number" id="score-home" name="score_home" value="{{ form.score_home if form is not none else (rule.score_home if rule and rule.score_home is not none else '') }}" placeholder="Qualquer">
              </div>
              <div class="col-6">
                <label class="small text-muted">Gols Fora</label>
                <input class="form-control" type="number" id="score-away" name="score_away" value="{{ form.score_away if form is not none else (rule.score_away if rule and rule.score_away is not none else '') }}" placeholder="Qualquer">
              </div>
            </div>
            <div class="form-text mt-2 small">Deixe em branco para monitorar qualquer placar.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- PASSO 3: REGRAS DE ESTATÃSTICAS -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold text-primary">ğŸ“Š Regras de EstatÃ­sticas</h6>
        <button type="button" class="btn btn-sm btn-primary" id="add-stat-condition">+ Adicionar CondiÃ§Ã£o</button>
      </div>
      <div class="card-body">
        <div id="stats-conditions-container"></div>
        <template id="stat-condition-template">
          <div class="stat-condition-block mb-3 p-3 border rounded-3 bg-light position-relative">
            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="small fw-bold">EstatÃ­stica</label>
                <select class="form-select stat-select">
                  <optgroup label="ğŸ“Š EstatÃ­sticas Ofensivas">
                    <option value="corners">ğŸš© Escanteios</option>
                    <option value="dangerous-attacks">âš¡ Ataques Perigosos</option>
                    <option value="on-target">ğŸ¯ Chutes no Alvo</option>
                    <option value="attacks">âš”ï¸ Ataques</option>
                    <option value="off-target">âŒ Chutes para Fora</option>
                    <option value="possession">ğŸ”„ Posse de Bola (%)</option>
                  </optgroup>
                  <optgroup label="âš½ Eventos">
                    <option value="goals">âš½ Gols</option>
                    <option value="yellow-cards">ğŸŸ¨ CartÃµes Amarelos</option>
                    <option value="red-cards">ğŸ”´ CartÃµes Vermelhos</option>
                  </optgroup>
                  <optgroup label="â±ï¸ Tempo">
                    <option value="Minute">â±ï¸ Minutos</option>
                  </optgroup>
                </select>
              </div>
              <div class="col-md-2 stat-side-wrap">
                <label class="small fw-bold">Time</label>
                <select class="form-select stat-side">
                  <option value="total">Total</option>
                  <option value="home">Casa</option>
                  <option value="away">Fora</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="small fw-bold">CondiÃ§Ã£o</label>
                <select class="form-select stat-operator">
                  <option value=">=">&gt;= (Pelo menos)</option>
                  <option value="<=">&lt;= (No mÃ¡ximo)</option>
                  <option value="==">= (Igual a)</option>
                  <option value="!=">â‰  (Diferente de)</option>
                  <option value=">">></option>
                  <option value="<"><</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="small fw-bold">Valor</label>
                <input class="form-control stat-value" type="number" value="3">
              </div>
              <div class="col-md-2 d-flex align-items-end justify-content-end">
                <button type="button" class="btn btn-outline-danger remove-stat-condition px-2" aria-label="Excluir condiÃ§Ã£o">âœ•</button>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- PASSO 4: RESULTADO (GREEN/RED) -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0 fw-bold text-primary">âœ… Resultado (Green/Red)</h6>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-6">
            <div class="p-3 border rounded-3 bg-light h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold text-success">GREEN</h6>
                <button type="button" class="btn btn-sm btn-outline-success" data-add-outcome="green">+ CondiÃ§Ã£o GREEN</button>
              </div>
              <div class="mb-3">
                <label class="small text-muted">Minuto para validar GREEN (opcional)</label>
                <input class="form-control" type="number" name="outcome_green_minute" value="{{ form.outcome_green_minute if form is not none else (rule.outcome_green_minute if rule and rule.outcome_green_minute is not none else '') }}" placeholder="Ex: 25">
              </div>
              <div id="outcome-green-container"></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 border rounded-3 bg-light h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold text-danger">RED</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" data-add-outcome="red">+ CondiÃ§Ã£o RED</button>
              </div>
              <div class="mb-3">
                <label class="small text-muted">Minuto para virar RED se GREEN nÃ£o ocorrer</label>
                <input class="form-control" type="number" name="outcome_red_minute" value="{{ form.outcome_red_minute if form is not none else (rule.outcome_red_minute if rule and rule.outcome_red_minute is not none else '') }}" placeholder="Ex: 45">
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" name="outcome_red_if_no_green" id="outcome-red-if-no-green" {% if form is not none %}{% if form.outcome_red_if_no_green %}checked{% endif %}{% elif rule and rule.outcome_red_if_no_green %}checked{% endif %}>
                <label class="form-check-label small text-muted" for="outcome-red-if-no-green">
                  Se nÃ£o bater o GREEN atÃ© o minuto acima, virar RED
                </label>
              </div>
              <div id="outcome-red-container"></div>
            </div>
          </div>
        </div>
        <p class="small text-muted mt-3 mb-0">Se definir condiÃ§Ãµes, elas serÃ£o usadas para decidir GREEN/RED. Se nÃ£o definir RED, vocÃª pode usar a opÃ§Ã£o de virar RED por tempo.</p>
      </div>
    </div>

    <template id="outcome-condition-template">
      <div class="outcome-condition-block mb-3 p-3 border rounded-3 bg-white position-relative">
        <div class="row g-2 align-items-end">
          <div class="col-md-4">
            <label class="small fw-bold">EstatÃ­stica</label>
            <select class="form-select outcome-stat-select">
              <optgroup label="ğŸ“Š EstatÃ­sticas Ofensivas">
                <option value="corners">ğŸš© Escanteios</option>
                <option value="dangerous-attacks">âš¡ Ataques Perigosos</option>
                <option value="on-target">ğŸ¯ Chutes no Alvo</option>
                <option value="attacks">âš”ï¸ Ataques</option>
                <option value="off-target">âŒ Chutes para Fora</option>
                <option value="possession">ğŸŸï¸ Posse de Bola (%)</option>
              </optgroup>
              <optgroup label="ğŸŸ¡ Eventos">
                <option value="goals">ğŸŸ¡ Gols</option>
                <option value="yellow-cards">ğŸŸ¨ CartÃµes Amarelos</option>
                <option value="red-cards">ğŸ”´ CartÃµes Vermelhos</option>
              </optgroup>
              <optgroup label="â±ï¸ Tempo">
                <option value="Minute">â±ï¸ Minutos</option>
              </optgroup>
            </select>
          </div>
          <div class="col-md-2 outcome-stat-side-wrap">
            <label class="small fw-bold">Time</label>
            <select class="form-select outcome-stat-side">
              <option value="total">Total</option>
              <option value="home">Casa</option>
              <option value="away">Fora</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="small fw-bold">CondiÃ§Ã£o</label>
            <select class="form-select outcome-stat-operator">
              <option value=">=">&gt;= (Pelo menos)</option>
              <option value="<=">&lt;= (No mÃ¡ximo)</option>
              <option value="==">= (Igual a)</option>
              <option value="!=">â‰  (Diferente de)</option>
              <option value=">">></option>
              <option value="<"><</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="small fw-bold">Valor</label>
            <input class="form-control outcome-stat-value" type="number" value="1">
          </div>
          <div class="col-md-2 d-flex align-items-end justify-content-end">
            <button type="button" class="btn btn-outline-danger remove-outcome-condition px-2" aria-label="Excluir condiÃ§Ã£o">âœ–</button>
          </div>
        </div>
      </div>
    </template>

    <!-- PASSO 5: MENSAGEM DO TELEGRAM -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0 fw-bold text-primary">ğŸ’¬ Mensagem no Telegram</h6>
      </div>
      <div class="card-body">
        <textarea class="form-control message-template mb-3" name="message_template" rows="5" style="font-family: monospace; font-size: 0.9rem;">{{ form.message_template if form is not none and form.message_template else (rule.message_template if rule and rule.message_template else default_message) }}</textarea>
        
        <div class="bg-light p-3 rounded-3">
          <p class="small fw-bold text-muted mb-2">VariÃ¡veis que vocÃª pode usar:</p>
          <div class="row g-2">
            <div class="col-md-6">
              <div class="p-2 border rounded bg-white small mb-2">
                <strong>BÃ¡sicas:</strong><br>
                <code>{rule}</code>, <code>{home_team}</code>, <code>{away_team}</code>, <code>{minute}</code>, <code>{score}</code>, <code>{league}</code>, <code>{url}</code>
              </div>
            </div>
            <div class="col-md-6">
              <div class="p-2 border rounded bg-white small mb-2">
                <strong>ğŸ“Š EstatÃ­sticas (Casa / Fora / Total):</strong><br>
                <div class="mt-2">
                  <span class="text-muted">ğŸš© Escanteios:</span><br>
                  <code>{corners_home}</code> / <code>{corners_away}</code> / <code>{corners_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">ğŸ¯ Chutes no Alvo:</span><br>
                  <code>{on_target_home}</code> / <code>{on_target_away}</code> / <code>{on_target_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">âš¡ Ataques Perigosos:</span><br>
                  <code>{dangerous_attacks_home}</code> / <code>{dangerous_attacks_away}</code> / <code>{dangerous_attacks_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">âš”ï¸ Ataques:</span><br>
                  <code>{attacks_home}</code> / <code>{attacks_away}</code> / <code>{attacks_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">âŒ Chutes para Fora:</span><br>
                  <code>{off_target_home}</code> / <code>{off_target_away}</code> / <code>{off_target_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">ğŸŸ¨ CartÃµes Amarelos:</span><br>
                  <code>{yellow_cards_home}</code> / <code>{yellow_cards_away}</code> / <code>{yellow_cards_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">ğŸ”´ CartÃµes Vermelhos:</span><br>
                  <code>{red_cards_home}</code> / <code>{red_cards_away}</code> / <code>{red_cards_total}</code>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BOTÃ•ES DE AÃ‡ÃƒO -->
    <div class="d-grid mb-3">
      <button type="button" class="btn btn-outline-primary btn-lg" id="test-rule">ğŸ§ª Testar Bot</button>
    </div>
    <div id="test-results" class="mb-3"></div>
    <div class="d-flex gap-3">
      <button class="btn btn-success btn-lg flex-grow-1 shadow-sm" type="submit">âœ… Salvar e Ativar Bot</button>
      <a class="btn btn-outline-secondary btn-lg" href="{{ url_for('rules.list_rules') }}">Cancelar</a>
    </div>

  </form>
</div>

<script>
  function syncMinuteMode(block) {
    const statSelect = block.querySelector('.stat-select');
    const sideWrap = block.querySelector('.stat-side-wrap');
    const sideSelect = block.querySelector('.stat-side');

    if (statSelect && statSelect.value === 'Minute') {
      sideSelect.value = 'total';
      sideWrap.classList.add('d-none');
    } else {
      sideWrap.classList.remove('d-none');
    }
  }

  const existingConditions = [
    {% if form_conditions %}
      {% for cond in form_conditions %}
        {
          stat_key: {{ cond.stat_key|tojson }},
          side: {{ cond.side|tojson }},
          operator: {{ cond.operator|tojson }},
          value: {{ cond.value }},
        },
      {% endfor %}
    {% elif rule and rule.conditions %}
      {% for cond in rule.conditions %}
        {
          stat_key: {{ cond.stat_key|tojson }},
          side: {{ cond.side|tojson }},
          operator: {{ cond.operator|tojson }},
          value: {{ cond.value }},
        },
      {% endfor %}
    {% endif %}
  ];

  const existingOutcomeGreen = [
    {% if form_outcome_green %}
      {% for cond in form_outcome_green %}
        {
          stat_key: {{ cond.stat_key|tojson }},
          side: {{ cond.side|tojson }},
          operator: {{ cond.operator|tojson }},
          value: {{ cond.value }},
        },
      {% endfor %}
    {% elif rule and rule.outcome_conditions %}
      {% for cond in rule.outcome_conditions if cond.outcome_type == 'green' %}
        {
          stat_key: {{ cond.stat_key|tojson }},
          side: {{ cond.side|tojson }},
          operator: {{ cond.operator|tojson }},
          value: {{ cond.value }},
        },
      {% endfor %}
    {% endif %}
  ];

  const existingOutcomeRed = [
    {% if form_outcome_red %}
      {% for cond in form_outcome_red %}
        {
          stat_key: {{ cond.stat_key|tojson }},
          side: {{ cond.side|tojson }},
          operator: {{ cond.operator|tojson }},
          value: {{ cond.value }},
        },
      {% endfor %}
    {% elif rule and rule.outcome_conditions %}
      {% for cond in rule.outcome_conditions if cond.outcome_type == 'red' %}
        {
          stat_key: {{ cond.stat_key|tojson }},
          side: {{ cond.side|tojson }},
          operator: {{ cond.operator|tojson }},
          value: {{ cond.value }},
        },
      {% endfor %}
    {% endif %}
  ];

  function refreshConditionNames() {
    const blocks = Array.from(document.querySelectorAll('.stat-condition-block'));
    blocks.forEach((block, index) => {
      const statSelect = block.querySelector('.stat-select');
      const sideSelect = block.querySelector('.stat-side');
      const operatorSelect = block.querySelector('.stat-operator');
      const valueInput = block.querySelector('.stat-value');

      if (statSelect) {
        statSelect.name = `conditions-${index}-stat_key`;
      }
      if (sideSelect) {
        sideSelect.name = `conditions-${index}-side`;
      }
      if (operatorSelect) {
        operatorSelect.name = `conditions-${index}-operator`;
      }
      if (valueInput) {
        valueInput.name = `conditions-${index}-value`;
      }
    });
  }

  function refreshOutcomeNames(type) {
    const blocks = Array.from(document.querySelectorAll(`.outcome-condition-block[data-outcome="${type}"]`));
    blocks.forEach((block, index) => {
      const statSelect = block.querySelector('.outcome-stat-select');
      const sideSelect = block.querySelector('.outcome-stat-side');
      const operatorSelect = block.querySelector('.outcome-stat-operator');
      const valueInput = block.querySelector('.outcome-stat-value');

      if (statSelect) {
        statSelect.name = `outcome-${type}-${index}-stat_key`;
      }
      if (sideSelect) {
        sideSelect.name = `outcome-${type}-${index}-side`;
      }
      if (operatorSelect) {
        operatorSelect.name = `outcome-${type}-${index}-operator`;
      }
      if (valueInput) {
        valueInput.name = `outcome-${type}-${index}-value`;
      }
    });
  }

  function normalizeOperator(value) {
    if (value === "â‰¥") {
      return ">=";
    }
    if (value === "â‰¤") {
      return "<=";
    }
    if (value === "=") {
      return "==";
    }
    return value;
  }

  function syncOutcomeMinuteMode(block) {
    const statSelect = block.querySelector('.outcome-stat-select');
    const sideWrap = block.querySelector('.outcome-stat-side-wrap');
    const sideSelect = block.querySelector('.outcome-stat-side');

    if (statSelect && statSelect.value === 'Minute') {
      sideSelect.value = 'total';
      sideWrap.classList.add('d-none');
    } else {
      sideWrap.classList.remove('d-none');
    }
  }

  function addOutcomeCondition(type, prefill) {
    const container = document.getElementById(`outcome-${type}-container`);
    const template = document.getElementById('outcome-condition-template');
    const newBlock = template.content.firstElementChild.cloneNode(true);
    newBlock.dataset.outcome = type;

    newBlock.querySelectorAll('input').forEach(i => i.value = '');

    if (prefill) {
      const statSelect = newBlock.querySelector('.outcome-stat-select');
      const sideSelect = newBlock.querySelector('.outcome-stat-side');
      const operatorSelect = newBlock.querySelector('.outcome-stat-operator');
      const valueInput = newBlock.querySelector('.outcome-stat-value');
      if (statSelect && prefill.stat_key) {
        statSelect.value = prefill.stat_key;
      }
      if (sideSelect && prefill.side) {
        sideSelect.value = prefill.side;
      }
      if (operatorSelect && prefill.operator) {
        operatorSelect.value = normalizeOperator(prefill.operator);
      }
      if (valueInput && prefill.value !== undefined && prefill.value !== null) {
        valueInput.value = prefill.value;
      }
    }

    newBlock.querySelector('.outcome-stat-select').addEventListener('change', function() {
      syncOutcomeMinuteMode(newBlock);
    });
    syncOutcomeMinuteMode(newBlock);

    newBlock.querySelector('.remove-outcome-condition').addEventListener('click', function() {
      newBlock.remove();
      refreshOutcomeNames(type);
    });

    container.appendChild(newBlock);
    refreshOutcomeNames(type);
  }

  function addCondition(prefill) {
    const container = document.getElementById('stats-conditions-container');
    const template = document.getElementById('stat-condition-template');
    const newBlock = template.content.firstElementChild.cloneNode(true);
    
    // Resetar valores
    newBlock.querySelectorAll('input').forEach(i => i.value = '');

    if (prefill) {
      const statSelect = newBlock.querySelector('.stat-select');
      const sideSelect = newBlock.querySelector('.stat-side');
      const operatorSelect = newBlock.querySelector('.stat-operator');
      const valueInput = newBlock.querySelector('.stat-value');
      if (statSelect && prefill.stat_key) {
        statSelect.value = prefill.stat_key;
      }
      if (sideSelect && prefill.side) {
        sideSelect.value = prefill.side;
      }
      if (operatorSelect && prefill.operator) {
        operatorSelect.value = normalizeOperator(prefill.operator);
      }
      if (valueInput && prefill.value !== undefined && prefill.value !== null) {
        valueInput.value = prefill.value;
      }
    }

    newBlock.querySelector('.stat-select').addEventListener('change', function() {
      syncMinuteMode(newBlock);
    });
    syncMinuteMode(newBlock);

    // Evento de remover
    newBlock.querySelector('.remove-stat-condition').addEventListener('click', function() {
      newBlock.remove();
      refreshConditionNames();
    });

    container.appendChild(newBlock);
    refreshConditionNames();
  }

  if (existingConditions.length) {
    existingConditions.forEach(condition => {
      addCondition(condition);
    });
  }

  if (existingOutcomeGreen.length) {
    existingOutcomeGreen.forEach(condition => {
      addOutcomeCondition('green', condition);
    });
  }
  if (existingOutcomeRed.length) {
    existingOutcomeRed.forEach(condition => {
      addOutcomeCondition('red', condition);
    });
  }

  document.getElementById('add-stat-condition').addEventListener('click', function() {
    addCondition();
  });

  document.querySelectorAll('[data-add-outcome]').forEach(btn => {
    btn.addEventListener('click', function() {
      const type = this.getAttribute('data-add-outcome');
      addOutcomeCondition(type);
    });
  });

  const redIfNoGreen = document.getElementById('outcome-red-if-no-green');
  const redMinuteInput = document.querySelector('input[name="outcome_red_minute"]');
  function syncRedMinuteRequired() {
    if (!redIfNoGreen || !redMinuteInput) {
      return;
    }
    redMinuteInput.required = redIfNoGreen.checked;
  }
  if (redIfNoGreen) {
    redIfNoGreen.addEventListener('change', syncRedMinuteRequired);
    syncRedMinuteRequired();
  }

  const secondHalfToggle = document.getElementById('second_half_only');
  const secondHalfNote = document.getElementById('second-half-note');
  function syncSecondHalfNote() {
    if (!secondHalfToggle || !secondHalfNote) {
      return;
    }
    secondHalfNote.style.display = secondHalfToggle.checked ? 'block' : 'none';
  }
  if (secondHalfToggle) {
    secondHalfToggle.addEventListener('change', syncSecondHalfNote);
    syncSecondHalfNote();
  }

// Inicializar botÃµes de remover existentes (se houver)
  document.querySelectorAll('.remove-stat-condition').forEach(btn => {
    btn.addEventListener('click', function() {
      this.closest('.stat-condition-block').remove();
      refreshConditionNames();
    });
  });
  document.querySelectorAll('.stat-condition-block').forEach(block => {
    const select = block.querySelector('.stat-select');
    if (!select) {
      return;
    }
    select.addEventListener('change', function() {
      syncMinuteMode(block);
    });
    syncMinuteMode(block);
  });
  refreshConditionNames();

  const testButton = document.getElementById('test-rule');
  const testResults = document.getElementById('test-results');
  const ruleForm = document.getElementById('rule-form');

  if (testButton && testResults && ruleForm) {
    testButton.addEventListener('click', async function() {
      refreshConditionNames();
      testButton.disabled = true;
      testResults.innerHTML = '<div class="text-muted small">Buscando jogos ao vivo...</div>';
      try {
        const response = await fetch('{{ url_for("rules.test_rule") }}', {
          method: 'POST',
          body: new FormData(ruleForm),
        });
        const data = await response.json();
        if (!response.ok || !data.ok) {
          const message = data && data.message ? data.message : 'Falha ao testar regra.';
          testResults.innerHTML = `<div class="alert alert-warning mb-0">${message}</div>`;
          return;
        }
        if (!data.matches || data.matches.length === 0) {
          testResults.innerHTML = '<div class="alert alert-info mb-0">Nenhum jogo encontrou as condiÃ§Ãµes agora.</div>';
          return;
        }
        const list = document.createElement('div');
        list.className = 'list-group';
        data.matches.forEach(match => {
          const item = document.createElement('div');
          item.className = 'list-group-item';
          const title = document.createElement('div');
          title.className = 'fw-bold';
          title.textContent = `${match.home_team} vs ${match.away_team}`;
          const meta = document.createElement('div');
          meta.className = 'small text-muted';
          meta.textContent = `Min: ${match.minute || '-'} | Placar: ${match.score || '-'}`;
          const link = document.createElement('a');
          link.href = match.url;
          link.target = '_blank';
          link.rel = 'noopener';
          link.textContent = match.url;
          item.appendChild(title);
          item.appendChild(meta);
          item.appendChild(link);
          list.appendChild(item);
        });
        testResults.innerHTML = '';
        testResults.appendChild(list);
      } catch (err) {
        testResults.innerHTML = '<div class="alert alert-warning mb-0">Erro ao testar regra.</div>';
      } finally {
        testButton.disabled = false;
      }
    });
  }

  if (ruleForm) {
    ruleForm.addEventListener('submit', function() {
      refreshConditionNames();
      refreshOutcomeNames('green');
      refreshOutcomeNames('red');
    });
  }

</script>

<style>
  .form-control:focus, .form-select:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.1);
  }
  .stat-condition-block:hover {
    border-color: #10b981 !important;
  }
  .remove-stat-condition {
    width: 2.25rem;
    height: 2.25rem;
    padding: 0;
  }
  code {
    color: #059669;
    background: #f0fdf4;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 0.85rem;
  }
</style>
{% endblock %}
