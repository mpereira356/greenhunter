{% extends "base.html" %}
{% block title %}Configurar Regra{% endblock %}
{% block content %}
{% set form = form_data if form_data is defined and form_data else None %}
{% set default_message = 'üì¢ {rule}\n‚è±Ô∏è Tempo: {minute}\'\nüèüÔ∏è {home_team} vs {away_team}\nü•Ö Placar: {score}\nüéØ √Ä Baliza: {on_target_home} x {on_target_away}\nüö© Escanteios: {corners_home} x {corners_away}\nüîó Abrir no site ({url})' %}

<div class="builder-shell rule-editor">
  <div class="page-header mb-4">
    <div>
      <h1 class="page-title">üöÄ Criar Hip√≥tese de Aposta</h1>
      <p class="page-subtitle">Configure seus crit√©rios de forma simples e receba alertas no Telegram.</p>
    </div>
  </div>

  <form method="post" id="rule-form" class="rule-form" novalidate>
    
    <!-- PASSO 1: IDENTIFICA√á√ÉO -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-9">
            <label class="form-label fw-bold">Nome da sua Estrat√©gia</label>
            <input class="form-control form-control-lg border-2" name="name" id="rule-name" value="{{ form.name if form is not none else (rule.name if rule else '') }}" placeholder="Ex: Funil de Escanteios HT" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">Status</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" name="is_active" id="is_active" style="width: 3em; height: 1.5em;" {% if form is not none %}{% if form.is_active %}checked{% endif %}{% elif rule is none or rule.is_active %}checked{% endif %}>
            </div>
            <div class="form-check form-switch mt-3">
              <input class="form-check-input" type="checkbox" name="second_half_only" id="second_half_only" {% if form is not none %}{% if form.second_half_only %}checked{% endif %}{% elif rule and rule.second_half_only %}checked{% endif %}>
              <label class="form-check-label small text-muted" for="second_half_only">
                Somente 2¬∫ tempo (zerar stats do quando estiver nos 45' HT)
              </label>
            </div>
            <div class="form-check form-switch mt-3">
              <input class="form-check-input" type="checkbox" name="notify_telegram" id="notify_telegram" {% if form is not none %}{% if form.notify_telegram %}checked{% endif %}{% elif rule is none or rule.notify_telegram %}checked{% endif %}>
              <label class="form-check-label small text-muted" for="notify_telegram">
                Avisar no Telegram
              </label>
            </div>
            <div class="form-check form-switch mt-3">
              <input class="form-check-input" type="checkbox" name="alert_on_penalty" id="alert_on_penalty" {% if form is not none %}{% if form.alert_on_penalty %}checked{% endif %}{% elif rule and rule.alert_on_penalty %}checked{% endif %}>
              <label class="form-check-label small text-muted" for="alert_on_penalty">
                Avisar se houver p√™nalti (dentro do limite da regra)
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PASSO 2: FILTRO DE PLACAR -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-0">
        <h6 class="mb-0 fw-bold text-primary">ü•Ö Filtro de Placar (Opcional)</h6>
      </div>
      <div class="card-body pt-0">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="small text-muted">Gols Casa</label>
            <input class="form-control" type="number" id="score-home" name="score_home" value="{{ form.score_home if form is not none else (rule.score_home if rule and rule.score_home is not none else '') }}" placeholder="Qualquer">
          </div>
          <div class="col-md-6">
            <label class="small text-muted">Gols Fora</label>
            <input class="form-control" type="number" id="score-away" name="score_away" value="{{ form.score_away if form is not none else (rule.score_away if rule and rule.score_away is not none else '') }}" placeholder="Qualquer">
          </div>
        </div>
        <div class="form-text mt-2 small">Deixe em branco para monitorar qualquer placar.</div>
      </div>
    </div>

    <!-- PASSO 3: REGRAS DE ESTAT√çSTICAS (GRUPOS) -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold text-primary">üìä Regras de Estat√≠sticas</h6>
        <button type="button" class="btn btn-sm btn-primary" id="add-condition-group">+ Adicionar Grupo (OU)</button>
      </div>
      <div class="card-body">
        <div id="groups-container"></div>
        <div class="form-text mt-2 small">
          <strong>Dica:</strong> Condi√ß√µes dentro de um grupo funcionam como <strong>E (AND)</strong>. Grupos diferentes funcionam como <strong>OU (OR)</strong>.
        </div>
      </div>
    </div>

    <!-- PASSO 4: RESULTADO (GREEN/RED) -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0 fw-bold text-primary">‚úÖ Condi√ß√µes do Resultado</h6>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-6">
            <div class="p-3 border rounded-3 bg-light h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold text-success">GREEN</h6>
                <button type="button" class="btn btn-sm btn-outline-success" data-add-outcome="green">+ Condi√ß√£o GREEN</button>
              </div>
              <div id="outcome-green-container"></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 border rounded-3 bg-light h-100">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0 fw-bold text-danger">RED</h6>
                <button type="button" class="btn btn-sm btn-outline-danger" data-add-outcome="red">+ Condi√ß√£o RED</button>
              </div>
              <div id="outcome-red-container"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PASSO 4.1: LIMITE DE TEMPO -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0 fw-bold text-primary">‚è±Ô∏è Limite de Tempo</h6>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="small text-muted">GREEN at√© o minuto (opcional)</label>
            <input class="form-control" type="number" name="outcome_green_minute" value="{{ form.outcome_green_minute if form is not none else (rule.outcome_green_minute if rule and rule.outcome_green_minute is not none else '') }}" placeholder="Ex: 25">
          </div>
          <div class="col-md-6">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="outcome_red_if_no_green" id="outcome-red-if-no-green" {% if form is not none %}{% if form.outcome_red_if_no_green %}checked{% endif %}{% elif rule and rule.outcome_red_if_no_green %}checked{% endif %}>
              <label class="form-check-label small text-muted" for="outcome-red-if-no-green">
                Virar RED se o GREEN n√£o bater
              </label>
            </div>
            <div id="outcome-red-minute-wrap">
              <label class="small text-muted">Minuto do RED</label>
              <input class="form-control" type="number" name="outcome_red_minute" value="{{ form.outcome_red_minute if form is not none else (rule.outcome_red_minute if rule and rule.outcome_red_minute is not none else '') }}" placeholder="Ex: 45">
            </div>
          </div>
        </div>
        <div class="form-text mt-2 small">O limite define at√© quando o GREEN precisa ocorrer.</div>
      </div>
    </div>

    <!-- PASSO 5: MENSAGEM -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0 fw-bold text-primary">üí¨ Mensagem do Alerta</h6>
      </div>
      <div class="card-body">
        <textarea class="form-control font-monospace" name="message_template" rows="6" placeholder="Sua mensagem personalizada...">{{ form.message_template if form is not none else (rule.message_template if rule and rule.message_template else default_message) }}</textarea>
        <div class="mt-2 small text-muted">
          Tags: <code>{rule}</code>, <code>{home_team}</code>, <code>{away_team}</code>, <code>{minute}</code>, <code>{score}</code>, <code>{url}</code>, <code>{league}</code>, <code>{time_limit}</code>, <code>{goals_home}</code>, <code>{goals_away}</code>, <code>{goals_total}</code>, <code>{corners_home}</code>, <code>{corners_away}</code>, <code>{corners_total}</code>, <code>{on_target_home}</code>, <code>{on_target_away}</code>, <code>{on_target_total}</code>, <code>{off_target_home}</code>, <code>{off_target_away}</code>, <code>{off_target_total}</code>, <code>{dangerous_attacks_home}</code>, <code>{dangerous_attacks_away}</code>, <code>{dangerous_attacks_total}</code>, <code>{history_h2h}</code>, <code>{history_home}</code>, <code>{history_away}</code>, <code>{history_confidence}</code>
        </div>
        <div class="mt-3 p-3 border rounded-3 bg-light">
          <div class="fw-semibold mb-2">Guia rapido das tags</div>
          <div class="row g-2 small">
            <div class="col-md-6">
              <div><code>{rule}</code> - nome da regra.</div>
              <div><code>{home_team}</code> - time da casa.</div>
              <div><code>{away_team}</code> - time visitante.</div>
              <div><code>{minute}</code> - minuto atual do jogo.</div>
              <div><code>{score}</code> - placar atual.</div>
              <div><code>{url}</code> - link do jogo.</div>
              <div><code>{league}</code> - liga/campeonato.</div>
              <div><code>{time_limit}</code> - limite da regra (min).</div>
              <div><code>{corners_home}</code> - escanteios da casa.</div>
              <div><code>{corners_away}</code> - escanteios do visitante.</div>
              <div><code>{corners_total}</code> - escanteios totais.</div>
            </div>
            <div class="col-md-6">
              <div><code>{goals_home}</code> - gols da casa.</div>
              <div><code>{goals_away}</code> - gols do visitante.</div>
              <div><code>{goals_total}</code> - gols totais.</div>
              <div><code>{on_target_home}</code> - chutes no alvo (casa).</div>
              <div><code>{on_target_away}</code> - chutes no alvo (visitante).</div>
              <div><code>{on_target_total}</code> - chutes no alvo (total).</div>
              <div><code>{off_target_home}</code> - chutes para fora (casa).</div>
              <div><code>{off_target_away}</code> - chutes para fora (visitante).</div>
              <div><code>{off_target_total}</code> - chutes para fora (total).</div>
              <div><code>{dangerous_attacks_home}</code> - ataques perigosos (casa).</div>
              <div><code>{dangerous_attacks_away}</code> - ataques perigosos (visitante).</div>
              <div><code>{dangerous_attacks_total}</code> - ataques perigosos (total).</div>
              <div><code>{history_h2h}</code> - resumo H2H.</div>
              <div><code>{history_home}</code> - resumo do historico do mandante.</div>
              <div><code>{history_away}</code> - resumo do historico do visitante.</div>
              <div><code>{history_confidence}</code> - confianca baseada no H2H (gols).</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-3">
      <a href="{{ url_for('rules.list_rules') }}" class="btn btn-light px-4">Cancelar</a>
      <button type="button" class="btn btn-outline-secondary px-4" id="test-rule">Testar bot</button>
      <button type="submit" class="btn btn-primary px-5">Salvar Estrat√©gia</button>
    </div>
    <div id="test-rule-result" class="test-rule-result mb-5" role="status" aria-live="polite"></div>
  </form>
</div>

<!-- TEMPLATES -->
<template id="group-template">
  <div class="condition-group mb-4 p-3 border rounded-3 bg-white shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0 fw-bold text-secondary group-title">Grupo de Condi√ß√µes</h6>
      <button type="button" class="btn btn-sm btn-outline-danger remove-group">Remover Grupo</button>
    </div>
    <div class="conditions-list"></div>
    <button type="button" class="btn btn-sm btn-outline-primary add-condition-to-group mt-2">+ Condi√ß√£o</button>
  </div>
</template>

<template id="condition-template">
  <div class="condition-row mb-2 p-2 border rounded bg-light position-relative">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <select class="form-select stat-select">
          <optgroup label="üìä Estat√≠sticas">
            <option value="corners">üö© Escanteios</option>
            <option value="dangerous-attacks">‚ö° Ataques Perigosos</option>
            <option value="on-target">üéØ Chutes no Alvo</option>
            <option value="attacks">‚öîÔ∏è Ataques</option>
            <option value="off-target">‚ùå Chutes para Fora</option>
            <option value="possession">üîÑ Posse de Bola (%)</option>
            <option value="goals">‚öΩ Gols</option>
            <option value="yellow-cards">üü® Cart√µes Amarelos</option>
            <option value="red-cards">üî¥ Cart√µes Vermelhos</option>
            <option value="Minute">‚è±Ô∏è Minutos</option>
          </optgroup>
        </select>
      </div>
      <div class="col-md-2 side-wrap">
        <select class="form-select stat-side">
          <option value="total">Total</option>
          <option value="home">Casa</option>
          <option value="away">Fora</option>
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select stat-operator">
          <option value=">=">&gt;=</option>
          <option value="<=">&lt;=</option>
          <option value="==">=</option>
          <option value=">">></option>
          <option value="<"><</option>
        </select>
      </div>
      <div class="col-md-2">
        <input class="form-control stat-value" type="number" value="0">
      </div>
      <div class="col-md-2 text-end">
        <button type="button" class="btn btn-sm btn-outline-danger remove-condition">‚úï</button>
      </div>
    </div>
  </div>
</template>

<template id="outcome-condition-template">
  <div class="outcome-condition-block mb-2 p-2 border rounded bg-white">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <select class="form-select outcome-stat-select">
          <option value="goals">‚öΩ Gols</option>
          <option value="corners">üö© Escanteios</option>
          <option value="on-target">üéØ Chutes no Alvo</option>
          <option value="Minute">‚è±Ô∏è Minutos</option>
        </select>
      </div>
      <div class="col-md-3 outcome-side-wrap">
        <select class="form-select outcome-stat-side">
          <option value="total">Total</option>
          <option value="home">Casa</option>
          <option value="away">Fora</option>
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select outcome-stat-operator">
          <option value=">=">&gt;=</option>
          <option value="==">=</option>
        </select>
      </div>
      <div class="col-md-2">
        <input class="form-control outcome-stat-value" type="number" value="1">
      </div>
      <div class="col-md-1 text-end">
        <button type="button" class="btn btn-sm btn-outline-danger remove-outcome-condition">‚úï</button>
      </div>
    </div>
  </div>
</template>

<script>
  const groupsContainer = document.getElementById('groups-container');
  const groupTemplate = document.getElementById('group-template');
  const conditionTemplate = document.getElementById('condition-template');
  const outcomeGreenContainer = document.getElementById('outcome-green-container');
  const outcomeRedContainer = document.getElementById('outcome-red-container');
  const outcomeTemplate = document.getElementById('outcome-condition-template');

  const existingConditions = {{ (form_conditions if form_conditions else (rule.conditions if rule else [])) | tojson }};
  const existingOutcomeGreen = {{ (form_outcome_green if form_outcome_green else (rule.outcome_conditions | selectattr('outcome_type', 'equalto', 'green') | list if rule else [])) | tojson }};
  const existingOutcomeRed = {{ (form_outcome_red if form_outcome_red else (rule.outcome_conditions | selectattr('outcome_type', 'equalto', 'red') | list if rule else [])) | tojson }};

  function addGroup(groupId = null) {
    const group = groupTemplate.content.firstElementChild.cloneNode(true);
    const id = groupId !== null ? groupId : groupsContainer.children.length;
    group.dataset.groupId = id;
    group.querySelector('.group-title').textContent = `Grupo ${id + 1} (OU)`;
    
    group.querySelector('.remove-group').addEventListener('click', () => {
      group.remove();
      refreshGroupIndices();
    });

    group.querySelector('.add-condition-to-group').addEventListener('click', () => {
      addConditionToGroup(group);
    });

    groupsContainer.appendChild(group);
    return group;
  }

  function normalizeStatKey(value) {
    const raw = (value || '').toString();
    const lowered = raw.toLowerCase();
    const map = {
      'corners': 'corners',
      'corner': 'corners',
      'dangerous attacks': 'dangerous-attacks',
      'dangerous-attacks': 'dangerous-attacks',
      'on target': 'on-target',
      'on-target': 'on-target',
      'attacks': 'attacks',
      'off target': 'off-target',
      'off-target': 'off-target',
      'possession': 'possession',
      'goals': 'goals',
      'goal': 'goals',
      'yellow cards': 'yellow-cards',
      'yellow-cards': 'yellow-cards',
      'red cards': 'red-cards',
      'red-cards': 'red-cards',
      'minute': 'Minute',
    };
    return map[lowered] || raw;
  }

  function addConditionToGroup(group, prefill = null) {
    const list = group.querySelector('.conditions-list');
    const cond = conditionTemplate.content.firstElementChild.cloneNode(true);
    
    if (prefill) {
      cond.querySelector('.stat-select').value = normalizeStatKey(prefill.stat_key);
      cond.querySelector('.stat-side').value = prefill.side;
      cond.querySelector('.stat-operator').value = prefill.operator;
      cond.querySelector('.stat-value').value = prefill.value;
    }

    cond.querySelector('.remove-condition').addEventListener('click', () => cond.remove());
    
    const statSelect = cond.querySelector('.stat-select');
    const sideWrap = cond.querySelector('.side-wrap');
    statSelect.addEventListener('change', () => {
      sideWrap.style.visibility = statSelect.value === 'Minute' ? 'hidden' : 'visible';
    });
    if (prefill && prefill.stat_key === 'Minute') sideWrap.style.visibility = 'hidden';

    list.appendChild(cond);
    refreshNames();
  }

  function addOutcome(type, prefill = null) {
    const container = type === 'green' ? outcomeGreenContainer : outcomeRedContainer;
    const cond = outcomeTemplate.content.firstElementChild.cloneNode(true);
    
    if (prefill) {
      cond.querySelector('.outcome-stat-select').value = normalizeStatKey(prefill.stat_key);
      cond.querySelector('.outcome-stat-side').value = prefill.side;
      cond.querySelector('.outcome-stat-operator').value = prefill.operator;
      cond.querySelector('.outcome-stat-value').value = prefill.value;
    }

    cond.querySelector('.remove-outcome-condition').addEventListener('click', () => cond.remove());
    container.appendChild(cond);
    refreshNames();
  }

  function refreshGroupIndices() {
    Array.from(groupsContainer.children).forEach((group, i) => {
      group.dataset.groupId = i;
      group.querySelector('.group-title').textContent = `Grupo ${i + 1} (OU)`;
    });
    refreshNames();
  }

  function refreshNames() {
    // Regras de Estat√≠sticas
    Array.from(groupsContainer.children).forEach((group, gIdx) => {
      const conditions = group.querySelectorAll('.condition-row');
      conditions.forEach((cond, cIdx) => {
        cond.querySelector('.stat-select').name = `group-${gIdx}-cond-${cIdx}-stat_key`;
        cond.querySelector('.stat-side').name = `group-${gIdx}-cond-${cIdx}-side`;
        cond.querySelector('.stat-operator').name = `group-${gIdx}-cond-${cIdx}-operator`;
        cond.querySelector('.stat-value').name = `group-${gIdx}-cond-${cIdx}-value`;
      });
    });

    // Outcomes
    ['green', 'red'].forEach(type => {
      const container = type === 'green' ? outcomeGreenContainer : outcomeRedContainer;
      Array.from(container.children).forEach((cond, i) => {
        cond.querySelector('.outcome-stat-select').name = `outcome-${type}-${i}-stat_key`;
        cond.querySelector('.outcome-stat-side').name = `outcome-${type}-${i}-side`;
        cond.querySelector('.outcome-stat-operator').name = `outcome-${type}-${i}-operator`;
        cond.querySelector('.outcome-stat-value').name = `outcome-${type}-${i}-value`;
      });
    });
  }

  // Inicializa√ß√£o
  document.getElementById('add-condition-group').addEventListener('click', () => {
    const group = addGroup();
    addConditionToGroup(group);
  });

  document.querySelectorAll('[data-add-outcome]').forEach(btn => {
    btn.addEventListener('click', () => addOutcome(btn.dataset.addOutcome));
  });

  // Carregar dados existentes
  if (existingConditions.length > 0) {
    const groups = {};
    existingConditions.forEach(c => {
      const gid = c.group_id || 0;
      if (!groups[gid]) groups[gid] = [];
      groups[gid].push(c);
    });
    Object.keys(groups).forEach(gid => {
      const group = addGroup(parseInt(gid));
      groups[gid].forEach(c => addConditionToGroup(group, c));
    });
  } else {
    const group = addGroup();
    addConditionToGroup(group);
  }

  existingOutcomeGreen.forEach(c => addOutcome('green', c));
  existingOutcomeRed.forEach(c => addOutcome('red', c));

  document.getElementById('rule-form').addEventListener('submit', refreshNames);

  const redToggle = document.getElementById('outcome-red-if-no-green');
  const redMinuteWrap = document.getElementById('outcome-red-minute-wrap');
  function syncRedMinute() {
    const show = redToggle && redToggle.checked;
    if (redMinuteWrap) redMinuteWrap.style.display = show ? '' : 'none';
  }
  if (redToggle) {
    redToggle.addEventListener('change', syncRedMinute);
    syncRedMinute();
  }
  function formatOperator(op) {
    if (op === '==') return '=';
    return op || '';
  }

  function buildConditionsSummary() {
    const groups = [];
    Array.from(groupsContainer.children).forEach((group, gIdx) => {
      const parts = [];
      const rows = group.querySelectorAll('.condition-row');
      rows.forEach((row, cIdx) => {
        const stat = row.querySelector('.stat-select')?.value || '';
        const side = row.querySelector('.stat-side')?.value || '';
        const op = row.querySelector('.stat-operator')?.value || '';
        const val = row.querySelector('.stat-value')?.value || '';
        if (!stat || !op || val === '') return;
        const sideLabel = stat === 'Minute' ? '' : ` ${side}`;
        parts.push(`${stat}${sideLabel} ${formatOperator(op)} ${val}`.trim());
      });
      if (parts.length) {
        groups.push(`Grupo ${gIdx + 1}: ${parts.join(' AND ')}`);
      }
    });
    return groups.join(' OR ');
  }

  function renderTestResult(state) {
    const result = document.getElementById('test-rule-result');
    result.innerHTML = '';

    const card = document.createElement('div');
    card.className = 'card border-0 shadow-sm test-rule-card';
    const body = document.createElement('div');
    body.className = 'card-body';

    const header = document.createElement('div');
    header.className = 'd-flex align-items-center gap-2 mb-2';
    const badge = document.createElement('span');
    badge.className = `badge ${state.badgeClass || 'text-bg-secondary'}`;
    badge.textContent = state.badgeText || 'INFO';
    const title = document.createElement('div');
    title.className = 'fw-bold';
    title.textContent = state.title || '';
    header.append(badge, title);
    body.append(header);

    if (state.subtitle) {
      const subtitle = document.createElement('div');
      subtitle.className = 'small text-muted mb-2';
      subtitle.textContent = state.subtitle;
      body.append(subtitle);
    }

    if (state.items && state.items.length) {
      const list = document.createElement('ul');
      list.className = 'list-unstyled mb-0';
      state.items.forEach(item => {
        const li = document.createElement('li');
        li.className = 'd-flex justify-content-between align-items-center py-2 border-top';
        const left = document.createElement('div');
        left.className = 'd-flex flex-column';
        const teams = document.createElement('div');
        teams.className = 'fw-semibold';
        teams.textContent = item.teams;
        left.append(teams);
        const extras = [];
        if (item.confidence) extras.push(`Conf: ${item.confidence}`);
        if (item.history_h2h) extras.push(item.history_h2h);
        if (item.history_home) extras.push(item.history_home);
        if (item.history_away) extras.push(item.history_away);
        if (extras.length) {
          const meta = document.createElement('div');
          meta.className = 'small text-muted';
          meta.textContent = extras.join(' | ');
          left.append(meta);
        }
        const minute = document.createElement('span');
        minute.className = 'badge text-bg-light';
        minute.textContent = item.minute;
        li.append(left, minute);
        list.append(li);
      });
      body.append(list);
    }

    card.append(body);
    result.append(card);
  }

  function renderLoading() {
    const result = document.getElementById('test-rule-result');
    result.innerHTML = '';
    const card = document.createElement('div');
    card.className = 'card border-0 shadow-sm test-rule-card';
    const body = document.createElement('div');
    body.className = 'card-body d-flex align-items-center gap-2';
    const spinner = document.createElement('span');
    spinner.className = 'spinner-border spinner-border-sm text-primary';
    spinner.setAttribute('role', 'status');
    spinner.setAttribute('aria-hidden', 'true');
    const text = document.createElement('div');
    text.className = 'fw-semibold';
    text.textContent = 'Testando...';
    body.append(spinner, text);
    card.append(body);
    result.append(card);
  }

  document.getElementById('test-rule').addEventListener('click', async () => {
    refreshNames();
    const conditionsSummary = buildConditionsSummary();
    renderLoading();
    try {
      const response = await fetch('{{ url_for("rules.test_rule") }}', {
        method: 'POST',
        body: new FormData(document.getElementById('rule-form')),
      });
      const data = await response.json();
      if (!response.ok || !data.ok) {
        renderTestResult({
          badgeClass: 'text-bg-danger',
          badgeText: 'ERRO',
          title: data.message || 'Falha ao testar.',
        });
        return;
      }
      if (!data.matches || data.matches.length === 0) {
        renderTestResult({
          badgeClass: 'text-bg-warning',
          badgeText: 'VAZIO',
          title: 'Nenhuma partida encontrada com esta regra agora.',
          subtitle: conditionsSummary ? `Condicoes: ${conditionsSummary}` : '',
        });
        return;
      }
      const items = data.matches.map(m => {
        const minute = m.minute !== null && m.minute !== undefined ? `${m.minute}'` : '-';
        const teams = `${m.home_team} vs ${m.away_team}`;
        return {
          teams,
          minute,
          confidence: m.history_confidence || '',
          history_h2h: m.history_h2h || '',
          history_home: m.history_home || '',
          history_away: m.history_away || '',
        };
      });
      renderTestResult({
        badgeClass: 'text-bg-success',
        badgeText: 'OK',
        title: `Encontradas ${data.matches.length} partida(s)`,
        subtitle: conditionsSummary ? `Condicoes: ${conditionsSummary}` : '',
        items,
      });
    } catch (err) {
      renderTestResult({
        badgeClass: 'text-bg-danger',
        badgeText: 'ERRO',
        title: 'Falha ao testar. Tente novamente.',
      });
    }
  });
</script>

<style>
  .condition-group { border-left: 5px solid #0d6efd !important; }
  .group-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
  .font-monospace { font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.85rem; }
  .test-rule-result .test-rule-card { border-left: 4px solid #0d6efd; }
</style>
{% endblock %}
