{% extends "base.html" %}
{% block title %}Configurar Regra{% endblock %}
{% block content %}
{% set default_message = 'ğŸ“¢ {rule}\nâ±ï¸ Tempo: {minute}\' (MÃ¡x: {time_limit} min)\nğŸŸï¸ {home_team} vs {away_team}\nğŸ¥… Placar: {score}\nğŸ¯ Ã€ Baliza: {on_target_home} x {on_target_away}\nğŸš© Escanteios: {corners_home} x {corners_away}\nğŸ”— Abrir no site ({url})' %}

<div class="builder-shell rule-editor">
  <div class="page-header mb-4">
    <div>
      <h1 class="page-title">ğŸš€ Criar HipÃ³tese de Aposta</h1>
      <p class="page-subtitle">Configure seus critÃ©rios de forma simples e receba alertas no Telegram.</p>
    </div>
  </div>

  <form method="post" id="rule-form" class="rule-form" novalidate>
    
    <!-- PASSO 1: IDENTIFICAÃ‡ÃƒO -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-7">
            <label class="form-label fw-bold">Nome da sua EstratÃ©gia</label>
            <input class="form-control form-control-lg border-2" name="name" id="rule-name" value="{{ rule.name if rule else '' }}" placeholder="Ex: Funil de Escanteios HT" required>
          </div>
          <div class="col-md-3">
            <label class="form-label fw-bold">Tempo Limite (Alerta)</label>
            <div class="input-group input-group-lg">
              <input class="form-control border-2" name="time_limit_min" id="time-limit-min" type="number" value="{{ rule.time_limit_min if rule else 30 }}" required>
              <span class="input-group-text bg-white border-2">min</span>
            </div>
          </div>
          <div class="col-md-2">
            <label class="form-label fw-bold">Status</label>
            <div class="form-check form-switch mt-2">
              <input class="form-check-input" type="checkbox" name="is_active" id="is_active" style="width: 3em; height: 1.5em;" {% if rule is none or rule.is_active %}checked{% endif %}>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PASSO 2: QUANDO MONITORAR (TEMPO E PLACAR) -->
    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white py-3 border-0">
            <h6 class="mb-0 fw-bold text-primary">â±ï¸ Intervalo de Tempo</h6>
          </div>
          <div class="card-body pt-0">
            <div class="row g-2">
              <div class="col-6">
                <label class="small text-muted">De (minuto)</label>
                <input class="form-control" type="number" id="time-from" value="1">
              </div>
              <div class="col-6">
                <label class="small text-muted">AtÃ© (minuto)</label>
                <input class="form-control" type="number" id="time-to" value="90">
              </div>
            </div>
            <div class="d-flex gap-2 mt-3">
              <button type="button" class="btn btn-sm btn-outline-secondary flex-grow-1" onclick="setPresetTime(1, 45)">1Âº Tempo</button>
              <button type="button" class="btn btn-sm btn-outline-secondary flex-grow-1" onclick="setPresetTime(46, 90)">2Âº Tempo</button>
              <button type="button" class="btn btn-sm btn-outline-primary flex-grow-1" onclick="setPresetTime(1, 90)">Jogo Todo</button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-header bg-white py-3 border-0">
            <h6 class="mb-0 fw-bold text-primary">ğŸ¥… Filtro de Placar (Opcional)</h6>
          </div>
          <div class="card-body pt-0">
            <div class="row g-2">
              <div class="col-6">
                <label class="small text-muted">Gols Casa</label>
                <input class="form-control" type="number" id="score-home" placeholder="Qualquer">
              </div>
              <div class="col-6">
                <label class="small text-muted">Gols Fora</label>
                <input class="form-control" type="number" id="score-away" placeholder="Qualquer">
              </div>
            </div>
            <div class="form-text mt-2 small">Deixe em branco para monitorar qualquer placar.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- PASSO 3: REGRAS DE ESTATÃSTICAS -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-bold text-primary">ğŸ“Š Regras de EstatÃ­sticas</h6>
        <button type="button" class="btn btn-sm btn-primary" id="add-stat-condition">+ Adicionar CondiÃ§Ã£o</button>
      </div>
      <div class="card-body">
        <div id="stats-conditions-container"></div>
        <template id="stat-condition-template">
          <div class="stat-condition-block mb-3 p-3 border rounded-3 bg-light position-relative">
            <div class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="small fw-bold">EstatÃ­stica</label>
                <select class="form-select stat-select">
                  <optgroup label="ğŸ“Š EstatÃ­sticas Ofensivas">
                    <option value="corners">ğŸš© Escanteios</option>
                    <option value="dangerous-attacks">âš¡ Ataques Perigosos</option>
                    <option value="on-target">ğŸ¯ Chutes no Alvo</option>
                    <option value="attacks">âš”ï¸ Ataques</option>
                    <option value="off-target">âŒ Chutes para Fora</option>
                    <option value="possession">ğŸ”„ Posse de Bola (%)</option>
                  </optgroup>
                  <optgroup label="âš½ Eventos">
                    <option value="goals">âš½ Gols</option>
                    <option value="yellow-cards">ğŸŸ¨ CartÃµes Amarelos</option>
                    <option value="red-cards">ğŸ”´ CartÃµes Vermelhos</option>
                  </optgroup>
                  <optgroup label="â±ï¸ Tempo">
                    <option value="Minute">â±ï¸ Minutos</option>
                  </optgroup>
                </select>
              </div>
              <div class="col-md-2 stat-side-wrap">
                <label class="small fw-bold">Time</label>
                <select class="form-select stat-side">
                  <option value="total">Total</option>
                  <option value="home">Casa</option>
                  <option value="away">Fora</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="small fw-bold">CondiÃ§Ã£o</label>
                <select class="form-select stat-operator">
                  <option value=">=">&gt;= (Pelo menos)</option>
                  <option value="<=">&lt;= (No mÃ¡ximo)</option>
                  <option value="==">= (Igual a)</option>
                  <option value="!=">â‰  (Diferente de)</option>
                  <option value=">">></option>
                  <option value="<"><</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="small fw-bold">Valor</label>
                <input class="form-control stat-value" type="number" value="3">
              </div>
              <div class="col-md-2 d-flex align-items-end justify-content-end">
                <button type="button" class="btn btn-outline-danger remove-stat-condition px-2" aria-label="Excluir condiÃ§Ã£o">âœ•</button>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- PASSO 4: MENSAGEM DO TELEGRAM -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-white py-3 border-bottom">
        <h6 class="mb-0 fw-bold text-primary">ğŸ’¬ Mensagem no Telegram</h6>
      </div>
      <div class="card-body">
        <textarea class="form-control message-template mb-3" name="message_template" rows="5" style="font-family: monospace; font-size: 0.9rem;">{{ rule.message_template if rule and rule.message_template else default_message }}</textarea>
        
        <div class="bg-light p-3 rounded-3">
          <p class="small fw-bold text-muted mb-2">VariÃ¡veis que vocÃª pode usar:</p>
          <div class="row g-2">
            <div class="col-md-6">
              <div class="p-2 border rounded bg-white small mb-2">
                <strong>BÃ¡sicas:</strong><br>
                <code>{rule}</code>, <code>{home_team}</code>, <code>{away_team}</code>, <code>{minute}</code>, <code>{score}</code>, <code>{league}</code>, <code>{url}</code>
              </div>
            </div>
            <div class="col-md-6">
              <div class="p-2 border rounded bg-white small mb-2">
                <strong>ğŸ“Š EstatÃ­sticas (Casa / Fora / Total):</strong><br>
                <div class="mt-2">
                  <span class="text-muted">ğŸš© Escanteios:</span><br>
                  <code>{corners_home}</code> / <code>{corners_away}</code> / <code>{corners_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">ğŸ¯ Chutes no Alvo:</span><br>
                  <code>{on_target_home}</code> / <code>{on_target_away}</code> / <code>{on_target_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">âš¡ Ataques Perigosos:</span><br>
                  <code>{dangerous_attacks_home}</code> / <code>{dangerous_attacks_away}</code> / <code>{dangerous_attacks_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">âš”ï¸ Ataques:</span><br>
                  <code>{attacks_home}</code> / <code>{attacks_away}</code> / <code>{attacks_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">âŒ Chutes para Fora:</span><br>
                  <code>{off_target_home}</code> / <code>{off_target_away}</code> / <code>{off_target_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">ğŸŸ¨ CartÃµes Amarelos:</span><br>
                  <code>{yellow_cards_home}</code> / <code>{yellow_cards_away}</code> / <code>{yellow_cards_total}</code>
                </div>
                <div class="mt-2">
                  <span class="text-muted">ğŸ”´ CartÃµes Vermelhos:</span><br>
                  <code>{red_cards_home}</code> / <code>{red_cards_away}</code> / <code>{red_cards_total}</code>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- BOTÃ•ES DE AÃ‡ÃƒO -->
    <div class="d-grid mb-3">
      <button type="button" class="btn btn-outline-primary btn-lg" id="test-rule">ğŸ§ª Testar Bot</button>
    </div>
    <div id="test-results" class="mb-3"></div>
    <div class="d-flex gap-3">
      <button class="btn btn-success btn-lg flex-grow-1 shadow-sm" type="submit">âœ… Salvar e Ativar Bot</button>
      <a class="btn btn-outline-secondary btn-lg" href="{{ url_for('rules.list_rules') }}">Cancelar</a>
    </div>

  </form>
</div>

<script>
  function setPresetTime(from, to) {
    document.getElementById('time-from').value = from;
    document.getElementById('time-to').value = to;
  }

  function syncMinuteMode(block) {
    const statSelect = block.querySelector('.stat-select');
    const sideWrap = block.querySelector('.stat-side-wrap');
    const sideSelect = block.querySelector('.stat-side');

    if (statSelect && statSelect.value === 'Minute') {
      sideSelect.value = 'total';
      sideWrap.classList.add('d-none');
    } else {
      sideWrap.classList.remove('d-none');
    }
  }

  function syncTimeLimitState() {
    const timeLimit = document.getElementById('time-limit-min');
    if (!timeLimit) {
      return;
    }
    const hasMinute = Array.from(document.querySelectorAll('.stat-select'))
      .some(select => select.value === 'Minute');
    if (hasMinute) {
      timeLimit.disabled = true;
      timeLimit.parentElement.classList.add('opacity-50');
    } else {
      timeLimit.disabled = false;
      timeLimit.parentElement.classList.remove('opacity-50');
    }
  }

  const existingConditions = [
    {% if rule and rule.conditions %}
      {% for cond in rule.conditions %}
        {
          stat_key: {{ cond.stat_key|tojson }},
          side: {{ cond.side|tojson }},
          operator: {{ cond.operator|tojson }},
          value: {{ cond.value }},
        },
      {% endfor %}
    {% endif %}
  ];

  function refreshConditionNames() {
    const blocks = Array.from(document.querySelectorAll('.stat-condition-block'));
    blocks.forEach((block, index) => {
      const statSelect = block.querySelector('.stat-select');
      const sideSelect = block.querySelector('.stat-side');
      const operatorSelect = block.querySelector('.stat-operator');
      const valueInput = block.querySelector('.stat-value');

      if (statSelect) {
        statSelect.name = `conditions-${index}-stat_key`;
      }
      if (sideSelect) {
        sideSelect.name = `conditions-${index}-side`;
      }
      if (operatorSelect) {
        operatorSelect.name = `conditions-${index}-operator`;
      }
      if (valueInput) {
        valueInput.name = `conditions-${index}-value`;
      }
    });
  }

  function normalizeOperator(value) {
    if (value === "â‰¥") {
      return ">=";
    }
    if (value === "â‰¤") {
      return "<=";
    }
    if (value === "=") {
      return "==";
    }
    return value;
  }

  function addCondition(prefill) {
    const container = document.getElementById('stats-conditions-container');
    const template = document.getElementById('stat-condition-template');
    const newBlock = template.content.firstElementChild.cloneNode(true);
    
    // Resetar valores
    newBlock.querySelectorAll('input').forEach(i => i.value = '');

    if (prefill) {
      const statSelect = newBlock.querySelector('.stat-select');
      const sideSelect = newBlock.querySelector('.stat-side');
      const operatorSelect = newBlock.querySelector('.stat-operator');
      const valueInput = newBlock.querySelector('.stat-value');
      if (statSelect && prefill.stat_key) {
        statSelect.value = prefill.stat_key;
      }
      if (sideSelect && prefill.side) {
        sideSelect.value = prefill.side;
      }
      if (operatorSelect && prefill.operator) {
        operatorSelect.value = normalizeOperator(prefill.operator);
      }
      if (valueInput && prefill.value !== undefined && prefill.value !== null) {
        valueInput.value = prefill.value;
      }
    }

    newBlock.querySelector('.stat-select').addEventListener('change', function() {
      syncMinuteMode(newBlock);
      syncTimeLimitState();
    });
    syncMinuteMode(newBlock);
    syncTimeLimitState();

    // Evento de remover
    newBlock.querySelector('.remove-stat-condition').addEventListener('click', function() {
      newBlock.remove();
      refreshConditionNames();
      syncTimeLimitState();
    });

    container.appendChild(newBlock);
    refreshConditionNames();
  }

  if (existingConditions.length) {
    existingConditions.forEach(condition => {
      addCondition(condition);
    });
  }

  document.getElementById('add-stat-condition').addEventListener('click', function() {
    addCondition();
  });

// Inicializar botÃµes de remover existentes (se houver)
  document.querySelectorAll('.remove-stat-condition').forEach(btn => {
    btn.addEventListener('click', function() {
      this.closest('.stat-condition-block').remove();
      refreshConditionNames();
      syncTimeLimitState();
    });
  });
  document.querySelectorAll('.stat-condition-block').forEach(block => {
    const select = block.querySelector('.stat-select');
    if (!select) {
      return;
    }
    select.addEventListener('change', function() {
      syncMinuteMode(block);
      syncTimeLimitState();
    });
    syncMinuteMode(block);
  });
  syncTimeLimitState();
  refreshConditionNames();

  const testButton = document.getElementById('test-rule');
  const testResults = document.getElementById('test-results');
  const ruleForm = document.getElementById('rule-form');

  if (testButton && testResults && ruleForm) {
    testButton.addEventListener('click', async function() {
      refreshConditionNames();
      testButton.disabled = true;
      testResults.innerHTML = '<div class="text-muted small">Buscando jogos ao vivo...</div>';
      try {
        const response = await fetch('{{ url_for("rules.test_rule") }}', {
          method: 'POST',
          body: new FormData(ruleForm),
        });
        const data = await response.json();
        if (!response.ok || !data.ok) {
          const message = data && data.message ? data.message : 'Falha ao testar regra.';
          testResults.innerHTML = `<div class="alert alert-warning mb-0">${message}</div>`;
          return;
        }
        if (!data.matches || data.matches.length === 0) {
          testResults.innerHTML = '<div class="alert alert-info mb-0">Nenhum jogo encontrou as condiÃ§Ãµes agora.</div>';
          return;
        }
        const list = document.createElement('div');
        list.className = 'list-group';
        data.matches.forEach(match => {
          const item = document.createElement('div');
          item.className = 'list-group-item';
          const title = document.createElement('div');
          title.className = 'fw-bold';
          title.textContent = `${match.home_team} vs ${match.away_team}`;
          if (match.condition_stats && match.condition_stats.length) {
            const details = document.createElement('div');
            details.className = 'small';
            details.textContent = match.condition_stats.map(stat => {
              const side = stat.key === 'Minute' ? '' : ` ${stat.side}`;
              const current = stat.current === null || stat.current === undefined ? '-' : stat.current;
              return `${stat.key}${side}: ${current} ${stat.operator} ${stat.target}`;
            }).join(' | ');
            item.appendChild(details);
          }
          const meta = document.createElement('div');
          meta.className = 'small text-muted';
          meta.textContent = `Min: ${match.minute || '-'} | Placar: ${match.score || '-'}`;
          const link = document.createElement('a');
          link.href = match.url;
          link.target = '_blank';
          link.rel = 'noopener';
          link.textContent = match.url;
          item.appendChild(title);
          item.appendChild(meta);
          item.appendChild(link);
          list.appendChild(item);
        });
        testResults.innerHTML = '';
        testResults.appendChild(list);
      } catch (err) {
        testResults.innerHTML = '<div class="alert alert-warning mb-0">Erro ao testar regra.</div>';
      } finally {
        testButton.disabled = false;
      }
    });
  }

  if (ruleForm) {
    ruleForm.addEventListener('submit', function() {
      refreshConditionNames();
    });
  }

</script>

<style>
  .form-control:focus, .form-select:focus {
    border-color: #10b981;
    box-shadow: 0 0 0 0.25rem rgba(16, 185, 129, 0.1);
  }
  .stat-condition-block:hover {
    border-color: #10b981 !important;
  }
  .remove-stat-condition {
    width: 2.25rem;
    height: 2.25rem;
    padding: 0;
  }
  code {
    color: #059669;
    background: #f0fdf4;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 0.85rem;
  }
</style>
{% endblock %}
