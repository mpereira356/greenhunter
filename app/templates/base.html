<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}GreenHunter{% endblock %}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    >
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
  </head>
  <body>
    {% if current_user.is_authenticated %}
    <div class="app-shell">
      <aside class="sidebar">
        <div class="sidebar-brand">
          <div class="brand-icon">+</div>
          <div class="brand-text">
            <div class="brand-title">GreenHunter</div>
            <div class="brand-sub">Bet Alerts</div>
          </div>
          <button class="sidebar-toggle" type="button">MENU</button>
        </div>
        <nav class="sidebar-nav">
          <a class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}" href="{{ url_for('main.dashboard') }}">
            <span class="nav-icon">D</span> Dashboard
          </a>
          <a class="nav-link {% if request.endpoint == 'main.live' %}active{% endif %}" href="{{ url_for('main.live') }}">
            <span class="nav-icon">L</span> Ao Vivo
          </a>
          {% if current_user.is_admin_user %}
          <a class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}" href="{{ url_for('admin.dashboard') }}">
            <span class="nav-icon">A</span> Admin
          </a>
          {% endif %}
          <a class="nav-link {% if request.endpoint in ['rules.list_rules','rules.create_rule','rules.edit_rule'] %}active{% endif %}" href="{{ url_for('rules.list_rules') }}">
            <span class="nav-icon">R</span> Minhas Regras
          </a>
          <a class="nav-link {% if request.endpoint == 'history.history' %}active{% endif %}" href="{{ url_for('history.history') }}">
            <span class="nav-icon">H</span> Historico
          </a>
          <a class="nav-link {% if request.endpoint == 'settings.settings' %}active{% endif %}" href="{{ url_for('settings.settings') }}">
            <span class="nav-icon">C</span> Configuracoes
          </a>
          <a class="nav-link" href="{{ url_for('auth.logout') }}">
            <span class="nav-icon">S</span> Sair
          </a>
        </nav>
      </aside>
      <div class="main-area">
        <header class="topbar">
          <div class="topbar-left">
            <div class="status-block">
              <span>Status da API:</span>
              <span class="status-pill status-wait" id="api-status">Verificando</span>
            </div>
          </div>
          <div class="topbar-right">
            <button class="btn btn-sm btn-outline-secondary me-2" type="button" id="theme-toggle">Modo escuro</button>
            <div class="user-chip">
              <div class="user-avatar">{{ (current_user.username[:1] if current_user.username else 'U')|upper }}</div>
              <div class="user-name">Ola, {{ current_user.username }}</div>
            </div>
          </div>
        </header>
        <main class="content">
    {% else %}
    <main class="container py-5 auth-shell">
    {% endif %}
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% if current_user.is_authenticated and (not current_user.telegram_token or not current_user.telegram_chat_id or not current_user.telegram_verified) %}
        <div class="alert alert-warning">
          Configure e teste seu Telegram em <a href="{{ url_for('settings.settings') }}">Configuracoes</a> para receber alertas.
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>

    {% if current_user.is_authenticated %}
      </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}
    {% if current_user.is_authenticated %}
    <script>
      const bodyEl = document.body;
      const themeToggle = document.getElementById("theme-toggle");
      function setTheme(mode) {
        if (mode === "dark") {
          bodyEl.classList.add("theme-dark");
          if (themeToggle) themeToggle.textContent = "Modo claro";
        } else {
          bodyEl.classList.remove("theme-dark");
          if (themeToggle) themeToggle.textContent = "Modo escuro";
        }
        localStorage.setItem("theme", mode);
      }
      const savedTheme = localStorage.getItem("theme") || "light";
      setTheme(savedTheme);
      if (themeToggle) {
        themeToggle.addEventListener("click", () => {
          const isDark = bodyEl.classList.contains("theme-dark");
          setTheme(isDark ? "light" : "dark");
        });
      }
      async function refreshApiStatus() {
        try {
          const resp = await fetch("{{ url_for('main.api_status') }}");
          const data = await resp.json();
          const badge = document.getElementById("api-status");
          if (!badge) return;
          if (data.ok === true) {
            badge.className = "status-pill status-on";
            badge.textContent = "API ON";
          } else if (data.ok === false) {
            badge.className = "status-pill status-off";
            const code = data.code ? ` (${data.code})` : "";
            badge.textContent = `API OFF${code}`;
          } else {
            badge.className = "status-pill status-wait";
            badge.textContent = "Verificando";
          }
        } catch (err) {
          const badge = document.getElementById("api-status");
          if (badge) {
            badge.className = "status-pill status-off";
            badge.textContent = "API OFF";
          }
        }
      }
      refreshApiStatus();
      setInterval(refreshApiStatus, 15000);
    </script>
    {% endif %}
  </body>
</html>

