<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}GreenHunter{% endblock %}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    >
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='app.css') }}">
    <style>
      /* Ajustes inline para Ã­cones e elementos especÃ­ficos */
      .nav-icon { font-style: normal; font-weight: 800; }
    </style>
  </head>
  <body>
    {% if current_user.is_authenticated %}
    <div class="app-shell">
      <aside class="sidebar">
        <div class="sidebar-brand">
          <div class="brand-icon" style="background: transparent; border-radius: 0;">
            <img src="{{ url_for('static', filename='img/greenhunter.png') }}"
                 alt="GreenHunter"
                 style="max-width: 100%; max-height: 100%; object-fit: contain;">
          </div>
          <div class="brand-text">
            <div class="brand-title">GreenHunter</div>
            <div class="brand-sub">Bet Intelligence</div>
          </div>
        </div>
        <nav class="sidebar-nav">
          <a class="nav-link {% if request.endpoint == 'main.dashboard' %}active{% endif %}" href="{{ url_for('main.dashboard') }}">
            <span class="nav-icon">ğŸ“Š</span> <span>Dashboard</span>
          </a>
          <a class="nav-link {% if request.endpoint == 'main.live' %}active{% endif %}" href="{{ url_for('main.live') }}">
            <span class="nav-icon">âš½</span> <span>Ao Vivo</span>
          </a>
          {% if current_user.is_admin_user %}
          <a class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}" href="{{ url_for('admin.dashboard') }}">
            <span class="nav-icon">ğŸ›¡ï¸</span> <span>Admin</span>
          </a>
          {% endif %}
          <a class="nav-link {% if request.endpoint in ['rules.list_rules','rules.create_rule','rules.edit_rule'] %}active{% endif %}" href="{{ url_for('rules.list_rules') }}">
            <span class="nav-icon">âš™ï¸</span> <span>Minhas Regras</span>
          </a>
          <a class="nav-link {% if request.endpoint == 'history.history' %}active{% endif %}" href="{{ url_for('history.history') }}">
            <span class="nav-icon">ğŸ“œ</span> <span>HistÃ³rico</span>
          </a>
          <a class="nav-link {% if request.endpoint == 'settings.settings' %}active{% endif %}" href="{{ url_for('settings.settings') }}">
            <span class="nav-icon">ğŸ”§</span> <span>ConfiguraÃ§Ãµes</span>
          </a>
          <div style="margin-top: auto; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
            <a class="nav-link" href="{{ url_for('auth.logout') }}">
              <span class="nav-icon">ğŸšª</span> <span>Sair</span>
            </a>
          </div>
        </nav>
      </aside>
      
      <div class="main-area">
        <header class="topbar">
          <div class="topbar-left">
            <div class="status-block d-flex align-items-center gap-2">
              <span class="text-muted small fw-bold">API STATUS:</span>
              <span class="status-pill status-wait" id="api-status">Verificando</span>
            </div>
          </div>
          <div class="topbar-right d-flex align-items-center gap-3">
            <button class="btn btn-sm btn-outline-secondary" type="button" id="theme-toggle">ğŸŒ™ Modo Escuro</button>
            <div class="user-chip d-flex align-items-center gap-2">
              <div class="user-avatar" style="width: 35px; height: 35px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                {{ (current_user.username[:1] if current_user.username else 'U')|upper }}
              </div>
              <div class="user-name fw-bold small">{{ current_user.username }}</div>
            </div>
          </div>
        </header>
        
        <main class="content">
    {% else %}
    <main class="auth-shell">
    {% endif %}
    
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category if category != 'message' else 'info' }} alert-dismissible fade show shadow-sm border-0" role="alert" style="border-left: 4px solid var(--primary) !important;">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      {% if active_broadcast %}
        <div class="alert alert-info shadow-sm border-0">
          <strong>Aviso:</strong> {{ active_broadcast.message }}
        </div>
      {% endif %}

      {% if current_user.is_authenticated and (not current_user.telegram_token or not current_user.telegram_chat_id or not current_user.telegram_verified) %}
        <div class="alert alert-warning shadow-sm border-0" style="border-left: 4px solid var(--warning) !important;">
          <div class="d-flex align-items-center gap-2">
            <span>âš ï¸</span>
            <span>Configure seu Telegram em <a href="{{ url_for('settings.settings') }}" class="fw-bold text-decoration-underline">ConfiguraÃ§Ãµes</a> para receber alertas.</span>
          </div>
        </div>
      {% endif %}

      {% block content %}{% endblock %}
    </main>

    {% if current_user.is_authenticated %}
      </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}
    {% if current_user.is_authenticated %}
    <script>
      const bodyEl = document.body;
      const themeToggle = document.getElementById("theme-toggle");
      
      function setTheme(mode) {
        if (mode === "dark") {
          bodyEl.classList.add("theme-dark");
          if (themeToggle) themeToggle.innerHTML = "â˜€ï¸ Modo Claro";
        } else {
          bodyEl.classList.remove("theme-dark");
          if (themeToggle) themeToggle.innerHTML = "ğŸŒ™ Modo Escuro";
        }
        localStorage.setItem("theme", mode);
      }
      
      const savedTheme = localStorage.getItem("theme") || "light";
      setTheme(savedTheme);
      
      if (themeToggle) {
        themeToggle.addEventListener("click", () => {
          const isDark = bodyEl.classList.contains("theme-dark");
          setTheme(isDark ? "light" : "dark");
        });
      }
      
      async function refreshApiStatus() {
        try {
          const resp = await fetch("{{ url_for('main.api_status') }}");
          const data = await resp.json();
          const badge = document.getElementById("api-status");
          if (!badge) return;
          if (data.ok === true) {
            badge.className = "status-pill status-on";
            badge.textContent = "ONLINE";
          } else {
            badge.className = "status-pill status-off";
            badge.textContent = "OFFLINE";
          }
        } catch (err) {
          const badge = document.getElementById("api-status");
          if (badge) {
            badge.className = "status-pill status-off";
            badge.textContent = "OFFLINE";
          }
        }
      }
      refreshApiStatus();
      setInterval(refreshApiStatus, 30000);
    </script>
    {% endif %}
  </body>
</html>
